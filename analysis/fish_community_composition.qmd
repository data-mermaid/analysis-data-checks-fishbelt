---
title: "Fish Community Composition Analysis"
author: "Iain R. Caldwell"
date: today
format: 
  html:
    embed-resources: true
editor: visual
code-fold: true
code-summary: "Show the code"
toc: true
title-block-banner: "#f0f3f5"
title-block-banner-color: "black"
include-after-body: "footer.html"
---

------------------------------------------------------------------------

This code analyzes fish community composition from MERMAID fishbelt data, focusing on family diversity and biomass composition by family and trophic group.

------------------------------------------------------------------------

## Getting example fishbelt data from MERMAID

Loads the necessary R packages and gets an example MERMAID project with fish belt data. Since the code relies on all three scales of MERMAID data (observations, sample units, and sample events), it is necessary to either select a MERMAID project whose permissions are set to public for fish belt or to use a project for which you are a member. Here I am exporting a public project so anyone can run the code - in this case a project tagged with "Blue Ventures". However, I also provide some example code (hashed out) that can be used to get a project for which you are a member.

**Note:** This step requires authentication even if you are accessing a public project. This means you need to create a free MERMAID account if you don't already have one.

```{r}
#| label: Load packages and export data
#| warning: false

rm(list = ls()) #remove past stored objects
options(scipen = 999) #turn off scientific notation

#### Load packages ####
library(mermaidr)
library(tidyverse)
library(plotly)
library(DT)
library(ggplot2)
library(ggpubr)
library(knitr)

#### Get data from an example project with public fishbelt data ####
allPublicFisbeltProjects <- mermaid_get_summary_sampleevents() %>% 
  filter(data_policy_beltfish == "public" & 
           !is.na(beltfish_biomass_kgha_avg) &
           !country %in% c("Indonesia", "Philippines") &
           grepl(pattern = "Blue Ventures", x = tags)) %>%
  group_by(project_id, project, tags, project_notes) %>% 
  dplyr::summarise(NumSites = length(site),
                   TotalSampleUnits = sum(beltfish_sample_unit_count)) %>% 
  arrange(desc(TotalSampleUnits))

targetProject <- allPublicFisbeltProjects[1,] #choose first project as example

targetFishAllData <- 
  mermaid_get_project_data(project = allPublicFisbeltProjects$project_id[1],
                           method = "fishbelt",
                           data = "all")

# #### Get data from a project for which you are a member ####
# my_projects <- mermaid_get_my_projects()
# 
# #The next line gets the first project - change the number to get a different one
# targetProject <- my_projects[1,] 
# 
# # Get all data levels
# targetFishAllData <- targetProject %>% 
#   mermaid_get_project_data(method = "fishbelt", data = "all")

# Extract the three levels
observations_data <- targetFishAllData$observations
sampleunits_data <- targetFishAllData$sampleunits
sampleevents_data <- targetFishAllData$sampleevents
```

------------------------------------------------------------------------

## Project information

```{r}
#| label: Project info
#| results: asis

# Assemble project information message
project_info <- paste0(
  "**Project analyzed:** ", allPublicFisbeltProjects$project[1], "\n\n",
  "**Project ID:** ", allPublicFisbeltProjects$project_id[1], "\n\n"
)

# Add tags if available
if (!is.na(allPublicFisbeltProjects$tags[1]) && allPublicFisbeltProjects$tags[1] != "") {
  project_info <- paste0(project_info, "**Tags:** ", allPublicFisbeltProjects$tags[1], "\n\n")
}

# Add project notes if available
if (!is.na(allPublicFisbeltProjects$project_notes[1]) && allPublicFisbeltProjects$project_notes[1] != "") {
  project_info <- paste0(project_info, "**Project notes:** ", allPublicFisbeltProjects$project_notes[1], "\n\n")
}

# Add data extracted
project_info <- paste0(project_info,
                       "**Data extracted:**\n\n", 
                       "- Observations: ", nrow(observations_data), " records\n",
                       "- Sample Units: ", nrow(sampleunits_data), " transects\n",
                       "- Sample Events: ", nrow(sampleevents_data), " sites\n",
                       "\n")

# Display the assembled message
cat(project_info)
```

------------------------------------------------------------------------

## Fish Family Diversity

### Number of Fish Families

```{r}
#| label: Family diversity summary

# Count unique families
n_families <- length(unique(observations_data$fish_family))

cat("Total number of fish families observed:", n_families, "\n\n")

# Families by site
families_by_site <- observations_data %>%
  group_by(site) %>%
  summarise(
    n_families = n_distinct(fish_family),
    n_genera = n_distinct(fish_genus),
    n_species = n_distinct(fish_taxon),
    total_observations = n()
  ) %>%
  arrange(desc(n_families))

kable(families_by_site,
      col.names = c("Site", "N Families", "N Genera", 
                    "N Species", "Total Obs"),
      caption = "Taxonomic Diversity by Site")
```

### Family Richness Distribution

```{r}
#| label: Family richness histogram
#| fig-width: 8
#| fig-height: 5

ggplot(families_by_site, aes(x = n_families)) +
  geom_histogram(binwidth = 2, fill = "#4575b4", 
                 color = "black", alpha = 0.7) +
  labs(
    title = "Distribution of Fish Family Richness Across Sites",
    x = "Number of Fish Families",
    y = "Number of Sites"
  ) +
  theme_classic() +
  theme(
    axis.text = element_text(size = 11, colour = "black"),
    axis.title = element_text(size = 12, colour = "black"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  )
```

### Complete Family List

```{r}
#| label: Family list

family_list <- observations_data %>%
  group_by(fish_family) %>%
  summarise(
    n_species = n_distinct(fish_taxon),
    total_count = sum(count, na.rm = TRUE)
  ) %>%
  arrange(fish_family)

datatable(family_list,
          colnames = c("Family", "N Species", "Total Count"),
          caption = "Complete List of Fish Families",
          options = list(pageLength = 15, autoWidth = TRUE))
```

------------------------------------------------------------------------

## Biomass Composition by Family

### Top Families by Biomass

Identifying which fish families contribute most to total biomass.

```{r}
#| label: Top families biomass

# Extract all family-specific biomass columns from sample events
family_cols <- grep("^biomass_kgha_fish_family_avg_", 
                    names(sampleevents_data), value = TRUE)

# Calculate true mean biomass for each family (replacing NAs with 0)
family_biomass <- sampleevents_data %>%
  select(all_of(family_cols)) %>%
  pivot_longer(cols = everything(),
               names_to = "fish_family",
               values_to = "biomass",
               names_prefix = "biomass_kgha_fish_family_avg_") %>%
  # Replace NAs with 0 to get true mean (including sites where family is absent)
  mutate(fish_family = str_to_title(fish_family),
         biomass = replace_na(biomass, 0)) %>%
  group_by(fish_family) %>%
  summarise(
    mean_biomass = mean(biomass, na.rm = TRUE),
    sd_biomass = sd(biomass, na.rm = TRUE),
    n_sites_present = sum(biomass > 0),
    n_sites_total = n()
  ) %>%
  mutate(
    percent_sites = 100 * n_sites_present / n_sites_total,
    # Calculate contribution to overall mean biomass across all families
    percent_total = 100 * mean_biomass / sum(mean_biomass)
  ) %>%
  arrange(desc(mean_biomass))

# Top 15 families
top_families <- head(family_biomass, 15)

kable(top_families,
      digits = 2,
      col.names = c("Family", "Mean Biomass (kg/ha)", "SD", 
                    "Sites Present", "Total Sites", "% Sites Present", 
                    "% of Total Biomass"),
      caption = "Top 15 Fish Families by Mean Biomass (true mean including zeros)")
```

### Biomass Proportion - Top Families

```{r}
#| label: Family biomass pie chart
#| fig-width: 10
#| fig-height: 8

# Prepare data for pie chart - top 10 plus "Other"
top10_families <- head(family_biomass, 10)
other_biomass <- sum(family_biomass$mean_biomass[11:nrow(family_biomass)])

pie_data <- top10_families %>%
  select(fish_family, mean_biomass) %>%
  bind_rows(tibble(fish_family = "Other families", 
                   mean_biomass = other_biomass))

# Create pie chart
plot_ly(pie_data, 
        labels = ~fish_family, 
        values = ~mean_biomass,
        type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        hoverinfo = 'text',
        text = ~paste(fish_family, '<br>',
                     round(mean_biomass, 1), 'kg/ha'),
        marker = list(line = list(color = '#FFFFFF', width = 2))) %>%
  layout(title = "Fish Biomass Composition by Family (Top 10 - Mean Biomass)",
         showlegend = TRUE,
         legend = list(orientation = 'v', 
                      x = 1.1, y = 0.5))
```

------------------------------------------------------------------------

## Biomass Composition by Trophic Group

```{r}
#| label: Trophic group biomass

# Get trophic group biomass from sample events
trophic_cols <- grep("biomass_kgha_trophic_group_avg_", 
                     names(sampleevents_data), value = TRUE)

trophic_biomass <- sampleevents_data %>%
  select(site, all_of(trophic_cols)) %>%
  pivot_longer(cols = all_of(trophic_cols),
               names_to = "trophic_group",
               values_to = "biomass",
               names_prefix = "biomass_kgha_trophic_group_avg_") %>%
  # Replace NAs with 0 to get true mean (including sites where group is absent)
  mutate(biomass = replace_na(biomass, 0)) %>%
  group_by(trophic_group) %>%
  summarise(
    mean_biomass = mean(biomass, na.rm = TRUE),
    q025 = quantile(biomass, 0.025, na.rm = TRUE),
    q975 = quantile(biomass, 0.975, na.rm = TRUE),
    n_sites_present = sum(biomass > 0),
    n_sites_total = n()
  ) %>%
  mutate(
    trophic_group = case_when(
      trophic_group == "planktivore" ~ "Planktivore",
      trophic_group == "herbivore_macroalgae" ~ "Herbivore (macroalgae)",
      trophic_group == "herbivore_detritivore" ~ "Herbivore (detritivore)",
      trophic_group == "invertivore_sessile" ~ "Invertivore (sessile)",
      trophic_group == "invertivore_mobile" ~ "Invertivore (mobile)",
      trophic_group == "omnivore" ~ "Omnivore",
      trophic_group == "piscivore" ~ "Piscivore",
      TRUE ~ trophic_group
    ),
    percent_sites = 100 * n_sites_present / n_sites_total,
    percent_total = 100 * mean_biomass / sum(mean_biomass)
  ) %>%
  arrange(desc(mean_biomass))

kable(trophic_biomass,
      digits = 2,
      col.names = c("Trophic Group", "Mean Biomass (kg/ha)", 
                    "2.5% Quantile", "97.5% Quantile",
                    "Sites Present", "Total Sites", "% Sites Present",
                    "% of Total Biomass"),
      caption = "Fish Biomass by Trophic Group (true mean including zeros)")
```

### Trophic Group Composition Bar Plot

```{r}
#| label: Trophic group bar plot
#| fig-width: 10
#| fig-height: 6

ggplot(trophic_biomass, 
       aes(x = reorder(trophic_group, mean_biomass), 
           y = mean_biomass, fill = trophic_group)) +
  geom_col(alpha = 0.8, color = "black", linewidth = 0.3) +
  geom_errorbar(aes(ymin = q025, ymax = q975),
                width = 0.3, linewidth = 0.5) +
  coord_flip() +
  labs(
    title = "Mean Fish Biomass by Trophic Group",
    subtitle = "Error bars show 95% quantiles (2.5% - 97.5%)",
    x = "Trophic Group",
    y = "Mean Biomass (kg/ha)"
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 11, colour = "black"),
    axis.title = element_text(size = 12, colour = "black"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray30")
  ) +
  scale_fill_brewer(palette = "Set3")
```

------------------------------------------------------------------------

## Community Composition Summary

```{r}
#| label: Summary statistics
#| results: asis

# Assemble the summary message with markdown
summary_msg <- paste0(
  "#### Taxonomic Diversity\n\n",
  "- **Fish families:** ", n_families, "\n",
  "- **Fish genera:** ", length(unique(observations_data$fish_genus)), "\n",
  "- **Fish species:** ", length(unique(observations_data$fish_taxon)), "\n\n",
  
  "#### Family Richness\n\n",
  "- **Mean families per site:** ", round(mean(families_by_site$n_families), 1), "\n",
  "- **Range:** ", min(families_by_site$n_families), " - ", 
                  max(families_by_site$n_families), "\n\n",
  
  "#### Biomass Composition\n\n",
  "- **Dominant family:** ", top_families$fish_family[1], " (", 
                           round(top_families$percent_total[1], 1), "% of total)\n",
  "- **Top 3 families account for:** ", 
                           round(sum(top_families$percent_total[1:3]), 1), "% of total biomass\n"
)

# Display the assembled summary
cat(summary_msg)
```

------------------------------------------------------------------------

## Notes and Recommendations

1.  **Family Diversity**: The observed family richness should be compared across sites to identify patterns related to habitat type, protection status, or environmental conditions.

2.  **Biomass Composition**: The dominance of particular families can indicate community structure and health. High diversity with balanced biomass distribution often indicates healthier reef systems.

3.  **Trophic Structure**: A balanced trophic structure with representation across all functional groups is typically associated with healthy, resilient reef ecosystems.

4.  **Regional Context**: Compare these results with expected community composition for the biogeographic region to identify any unusual patterns.
